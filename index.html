<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voiceflow Chatbot with Multiple Extensions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script> <!-- Include jsPDF library -->
</head>
<body>
    <h1>Voiceflow Chatbot with Multiple Extensions</h1>

    <!-- Updated Custom Button Extension Script -->
    <script>
    const CustomButtonExtension = {
      name: 'CustomButtons',
      type: 'response',
      match: ({ trace }) =>
        trace.type === 'Custom_buttons' || trace.payload.name === 'Custom_buttons',
      render: ({ trace, element }) => {
        console.log("Custom button step detected."); // Debugging log

        // Target the Voiceflow widget root and apply styles specifically for this step
        const voiceflowWidget = document.querySelector('.vfrc-widget');
        if (voiceflowWidget) {
          voiceflowWidget.style.backgroundColor = '#ffffff';
          voiceflowWidget.style.boxShadow = 'none';
        }

        // Individual button containers for each button
        const buttonContainer = document.createElement('div');
        buttonContainer.innerHTML = `
          <style>
            .button-container {
              background-color: #ffffff;
              border: 2px solid #007bff;
              border-radius: 20px;
              margin: 10px 0;
              display: flex;
              justify-content: center;
            }
            .custom-button {
              color: #007bff;
              background-color: #ffffff;
              border: none;
              font-size: 14px;
              font-family: Arial, sans-serif;
              border-radius: 20px;
              cursor: pointer;
              padding: 10px 20px;
              text-align: center;
              transition: background-color 0.3s, color 0.3s;
            }
            .custom-button:hover {
              background-color: #007bff;
              color: #ffffff;
            }
            .tooltip {
              display: none;
              position: absolute;
              background-color: #ffffff;
              color: #007bff;
              border-radius: 4px;
              padding: 5px;
              font-size: 12px;
              top: -30px;
              left: 50%;
              transform: translateX(-50%);
              border: 1px solid #007bff;
            }
            .button-container:hover .tooltip {
              display: block;
            }
          </style>
          <div class="button-container">
              <button class="custom-button" data-button="Decision Journey">Decision Journey</button>
              <span class="tooltip">Brief description for Decision Journey</span>
          </div>
          <div class="button-container">
              <button class="custom-button" data-button="FAQ AI/Automation Platform">FAQ AI/Automation Platform</button>
              <span class="tooltip">Brief description for FAQ AI/Automation Platform</span>
          </div>
          <div class="button-container">
              <button class="custom-button" data-button="Why Service Transformation">Why Service Transformation</button>
              <span class="tooltip">Brief description for Why Service Transformation</span>
          </div>
        `;

        element.appendChild(buttonContainer);

        const buttons = buttonContainer.querySelectorAll('.custom-button');
        buttons.forEach(button => {
          button.addEventListener('click', () => {
            const buttonName = button.getAttribute('data-button');

            window.voiceflow.chat.interact({
              type: 'complete',
              payload: { selectedButton: buttonName },
            });

            buttonContainer.remove();

            if (voiceflowWidget) {
              voiceflowWidget.style.backgroundColor = '';
              voiceflowWidget.style.boxShadow = '';
            }
          });
        });
      },
    };
    </script>

    <!-- PDF Creator Extension Script -->
    <script>
    const pdfCreatorExtension = {
      name: 'pdfcreator',
      type: 'response',
      match: ({ trace }) =>
        trace.type === 'pdf' || trace.payload.name === 'pdf',
      render: ({ trace, element }) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text("PDF Report", 10, 10);
        doc.setFontSize(12);
        doc.text("This PDF contains information based on your form responses.", 10, 20);

        //const imgData = "data:image/png;base64,iVBOAAAASUVORK5CYII=";
        //doc.addImage(imgData, 'PNG', 10, 30, 100, 100);

        const responses = trace.payload || {};
        let yPosition = 90;

        for (const [question, answer] of Object.entries(responses)) {
          doc.text(`${question}: ${answer}`, 10, yPosition);
          yPosition += 10;
        }

        const pdfBlob = doc.output('blob');
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(pdfBlob);
        downloadLink.download = "GeneratedDocument.pdf";
        downloadLink.textContent = "Download recommendation as PDF";
        downloadLink.style.display = "inline-block";
        downloadLink.style.marginTop = "10px";
        downloadLink.style.padding = "8px 12px";
        downloadLink.style.color = "#ffffff";
        downloadLink.style.backgroundColor = "#4CAF50";
        downloadLink.style.borderRadius = "5px";
        downloadLink.style.textDecoration = "none";

        element.appendChild(downloadLink);
      },
    };
    </script>

    <!-- Free Text Toggle Extension Script -->
    <script>
    const freeTextToggleExtension = {
      name: 'freeTextToggle',
      type: 'response',
      match: ({ trace }) =>
        trace.payload && (trace.payload.name === 'remove_freetext' || trace.payload.name === 'add_freetext'),
      render: ({ trace }) => {
        console.log(`${trace.payload.name} step detected.`);

        function updateFreeTextInput(retries = 10) {
          const vfWidgetContainers = document.querySelectorAll('*');
          
          for (let container of vfWidgetContainers) {
            if (container.shadowRoot) {
              const freeTextInput = container.shadowRoot.querySelector('textarea[id^="vf-chat-input"]');
              
              if (freeTextInput) {
                if (trace.payload.name === 'remove_freetext') {
                  freeTextInput.placeholder = "Please use the buttons and don't refresh the page";
                  freeTextInput.readOnly = true;
                } else if (trace.payload.name === 'add_freetext') {
                  freeTextInput.placeholder = "Messageâ€¦";
                  freeTextInput.readOnly = false;
                }
                return;
              }
            }
          }

          if (retries > 0) {
            setTimeout(() => updateFreeTextInput(retries - 1), 500);
          } else {
            console.log("Failed to find textarea within shadow DOM after retries.");
          }
        }

        updateFreeTextInput();
      },
    };
    </script>

    <!-- Voiceflow Chat Widget Script with Extensions -->
    <script type="text/javascript">
      (function(d, t) {
          var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
          v.onload = function() {
            window.voiceflow.chat.load({
              verify: { projectID: '6729fb4d35486c906bb68057' },
              url: 'https://general-runtime.voiceflow.com',
              versionID: 'production',
              assistant: {
                extensions: [CustomButtonExtension, pdfCreatorExtension, freeTextToggleExtension],
              }
            });
          };
          v.src = "https://cdn.voiceflow.com/widget/bundle.mjs"; 
          v.type = "text/javascript"; 
          s.parentNode.insertBefore(v, s);
      })(document, 'script');
    </script>
</body>
</html>
